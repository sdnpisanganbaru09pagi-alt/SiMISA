<!DOCTYPE html>

<html lang="id">
<head>
<link rel="manifest" href="manifest.json">
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,maximum-scale=1" name="viewport"/>
<title>SiMISA — Peminjaman Barang (Dioptimalkan)</title>
<style>
:root{
  --bg-1:#0f172a;
  --card:#ffffff;
  --accent-1:#6c5ce7;
  --accent-2:#00d2ff;
  --muted:#6b7280;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  --glass: rgba(255,255,255,0.06);
  --radius:14px;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background: linear-gradient(180deg,#071024 0%, #0b1220 100%);
  color: #0b1220;
  -webkit-font-smoothing:antialiased;
  padding:12px;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  font-size:15px;
  line-height:1.35;
}
.app {
  width:100%;
  max-width:760px;
  background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.94));
  border-radius:18px;
  overflow:hidden;
  box-shadow: 0 12px 40px rgba(2,6,23,0.6);
  margin-bottom:24px;
}
/* header */
.header {
  padding: 16px 16px;
  background: linear-gradient(270deg, var(--accent-1), var(--accent-2), #ff7eb3, #6c5ce7);
  background-size: 600% 600%;
  animation: gradientShift 12s ease infinite;
  color: white;
  display: flex;
  gap: 12px;
  align-items: center;
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
.brand {
  display:flex;
  gap:12px;
  align-items:center;
  flex:1;
}
.logo{
  width:50px;height:50px;border-radius:10px;
  background:linear-gradient(135deg,#ffffff55,transparent);
  display:flex;align-items:center;justify-content:center;font-weight:700;
  box-shadow: 0 6px 18px rgba(0,0,0,0.18);
}
.title{font-weight:700;font-size:1.05rem}
.subtitle{font-size:0.85rem;opacity:0.95}
.header-actions{display:flex;gap:8px}

/* main */
.main{padding:14px}

/* tabs (mobile-first vertical) */
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tab{
  flex:1 1 48%;
  padding:10px 12px;
  background:transparent;border-radius:10px;border:1px solid rgba(11,17,34,0.04);
  font-weight:600;text-align:center;color:var(--muted);
  cursor:pointer;user-select:none;
}
.tab.active{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;box-shadow:0 6px 18px rgba(108,92,231,0.18)}
@media(min-width:720px){ .tab{flex:1 1 24%} }

/* stats */
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.stat{
  background:var(--card);padding:12px;border-radius:10px;text-align:center;box-shadow:0 6px 18px rgba(2,6,23,0.06);
}
.stat .n{font-weight:800;font-size:1.15rem;color:var(--accent-1)}
.stat .label{font-size:12px;color:var(--muted)}

/* search */
.search{display:flex;gap:8px;margin-bottom:12px}
.search input{
  flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(11,17,34,0.06);
  background:transparent;font-size:14px;
}

/* items list */
.list{display:grid;gap:10px}
.card{
  display:flex;flex-direction:column;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);
  border:1px solid rgba(11,17,34,0.04);
}
.card .top{display:flex;justify-content:space-between;align-items:center;gap:8px}
.badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
.badge.available{background:linear-gradient(90deg,var(--success),#34d399);color:white}
.badge.borrowed{background:linear-gradient(90deg,var(--warning),#f97316);color:#1f2937}
.card h3{margin:8px 0 6px;font-size:1rem}
.meta{color:var(--muted);font-size:13px}

/* actions */
.actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{
  padding:10px 12px;border-radius:10px;border:0;font-weight:700;font-size:13px;cursor:pointer;
  display:inline-flex;gap:8px;align-items:center;justify-content:center;
}
.btn.ghost{background:transparent;border:1px solid rgba(11,17,34,0.06);color:var(--muted)}
.btn.primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white}
.btn.danger{background:linear-gradient(90deg,#fb7185,#ef4444);color:white}
.btn.full{flex:1}

/* forms */
.form{display:grid;gap:10px}
.input, .select, .file{
  padding:12px;border-radius:10px;border:1px solid rgba(11,17,34,0.06);background:transparent;font-size:14px;
}
.file{display:flex;align-items:center;gap:8px}

/* photo preview */
.preview{position:relative;border-radius:10px;overflow:hidden;margin-top:6px}
.preview img{width:100%;height:auto;display:block}

/* small helpers */
.note{font-size:12px;color:var(--muted)}
.hr{height:1px;background:linear-gradient(90deg,transparent,#eee,transparent);margin:10px 0;border-radius:2px;padding:0}

/* footer */
.footer{padding:12px;background:linear-gradient(180deg,rgba(11,17,34,0.02),transparent);display:flex;gap:8px;flex-wrap:wrap}
.small{font-size:12px;color:var(--muted)}

/* accessibility focus */
.tab:focus,.btn:focus,input:focus,select:focus{outline: 3px solid rgba(99,102,241,0.14);outline-offset:2px}

/* responsive tweaks */
@media(max-width:420px){
  
  .tab{flex-basis:100%}
}

.btn.active {
  background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
  color: white;
  box-shadow: 0 6px 18px rgba(108,92,231,0.18);
}


.card.available {
  background: linear-gradient(180deg,#fff,#fbfdff);
}

.card.borrowed {
  background: linear-gradient(180deg, #fff7ed, #fde68a); /* soft orange */
}


.btn.borrowed-return {
  background: linear-gradient(90deg,var(--warning),#f97316);
  color: white;
}


.view {
  opacity: 1;
  transition: opacity 0.35s ease;
}
.view.fade-in {
  opacity: 0;
  animation: fadeIn 0.35s forwards;
}
@keyframes fadeIn {
  to { opacity: 1; }
}


.photo-upload-container {
    position: relative;
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}
.photo-upload-container:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}
.photo-upload-container input[type="file"] {
    opacity: 0;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    z-index: 2;
}
.upload-placeholder {
    color: #666;
}
.upload-icon {
    font-size: 2.5rem;
    margin-bottom: 5px;
}
.photo-upload-container.has-image .upload-placeholder {
    display: none;
}
.photo-preview img {
    width: 100%;
    height: auto;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
}
.btn-remove-photo {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s ease;
    z-index: 3;
}
.btn-remove-photo:hover {
    background: #dc3545;
    transform: scale(1.05);
}

</style>
</head>
<body>

  <script>
  if (typeof navigator.serviceWorker !== 'undefined') {
    navigator.serviceWorker.register('sw.js')
  }
</script>

<div aria-label="SiMISA mobile item lending app" class="app" role="application">
<header class="header">
<div class="brand">
<div aria-hidden="true" class="logo" style="background:none;padding:0;">
<img alt="SiMISA logo" src="data:image/webp;base64,UklGRvAIAABXRUJQVlA4IOQIAACwKgCdASpkAGQAPjEWiUMiISES/jZMIAMEtABooQyv701+i/g3+S3zU1x+YfdH8oOvDLv00fqP7X+N3v69SP5A9gD9HP9j9tPcv8w386/vX7Yey7/w/9B7l/1a/0fuAfyj++9Yd+wHsAfsn6XX7jfBr+1X7ifAR+xP/0vTH7v0X/hz2Zykn3r8tvyx4tf+e9Av+R/3H8suK+yn/m+509HvlV9En+/ccJGv54P/F/mPP18+f9X3C/1d/2vYw/bf2aP28MsALRlRGR1TlyhSMxvWi5HIJmLYubnNlWuvCuc8NDyQ2ZyTFiQEjs2R9DNpX/zEXthYeJ53yDV4X34FKI+79JR33Z044ibchyx6s9AD684M+2NZF6twqgT+tF+U0rTZ62PokC7K/qv+9q4c+4YX+e6an8sAwzaiUmpcUIy153AJoHPnUmMuEdSxrJYn7kj5Us3zpUtA+wqzfZNIAAD+//4mgoeFSnoAKPw5k91aSVGR+xF0OpYOb9ASk2x/wpaVXf2edgpc7MVXjE463pQkBkHxzAM0wmuOtHqJ82SFKZ508Jhr8F/dSxASNuM2rb5MR8Z6K4MZu/fQ4jT4dvxwYe2CVCal+/1Ip3z4AWmgAsVACXX9zEE5qMPyw20U1a/al4k7rjaILwPF4z1xPJrLf2kORBiqHj6reaVttmqM3Bq2iEHPRX61piRuRaemo36GWbTkts0O1lcHi3+4TR+iVTRL4VQs5uZGnYJ318x02xdPWLz+2ZhIM6DIog2EWvWMdzDk412mCKeIhSWAdjZQ8Dh2fKMZRBv1t1/RCkf5c4tL0ZGlGEIzE73CiB9sLYwRblTNcurJ2Z4u/zSNqmW2Bc/mctGHBjbryey/ZAl98ffAmI3nwyseAjHLx3EC6eYMrPtKeWXbCUxnKVUYE6TN1804TzfaDRwQO0AyGDP6ED7i7PZHThnxjXV+OZnkPDU7Y4QBUt8BPbAzCUQSkuARQlUMY4fTKHXgiFpcGAJwAsyxMBaa8oiVYacvlrJitfTvw8u/8r1/cfN9Eflqu1gRCatQuewwJMuogrEuTTbZoOXxcLBVPDUlSBAHKGc7U1jXHU4uqRGSnFQuqySEOESvY4YpsiSMHG6OJYqcJ+qMIi0RlxIQeW1hvuZEYFiAnX/+G4wA3OlHVEgtUm8KZ/1e+7c519dlnej8Eq6iyTHslgvR/VpYpO+qBAGSDRp95AwR264MVkm4Rn4c4rNxtvrSXLiyl5GWBigfwvgH5Klp8sy39eUsTxsg8HtdHheaurPL161h+3KQw3X/ycRAEFmaOTfXwU3KvdAmVOL0k8vyMcWZo6z3Mesbaq2/+A/i+8obT+jweJ6s7HThsyO6/8WOHHebykJD8AtqIqXQLegWiQzlClun8eUjkTvf8w23W/5Pm+jFgQmEA3+A9V/rw5/RfEuQ2cboBAq4CwCWLZ1Y0uz94KyLKRsN3GdVpRAe+KHMf5jIXXgYSOGhnqfd+PDZP9GKdOh+tAHsaX5M+u8nMU1Ai8WSlUtXe6OJXkz3KVcOaob8+zxfewL45FXVaLxZCfMqTAlfD8qH7xIqg5iksNq/jLOU5D0BF2xP4nUko2KEzJjkYby5tkqds8K/6+Pu8vOANvj7gaufkBWbjuudp99XdBBX7M48JnqhdkQH94v0kPdlMsDiLjuvbNHT1Kw422sCao0l0foRwfdB65P8kwD+npbxqfgCAQ1skKCg2KKPMWT8TIYduGxPnuCMgljsOYJsobrs/Dt7J0rFB9A5PMmeP+BdnQebD8btgH8LEOF1FIMX6T9mAa+LTBiyQsp0vrk8H4dcx+P5TIVd9UBmA3cJfW/q0IB1fo49kEySR1vBjatmo+eKga847BLGdVf66vP73dNFK3HUwIe1dB0V2GKev4fOm5fHFUahaKcXCY78kPAXywVFHJPhT3fgRyCLTffj8Us1wQGt3x4gi33SGPMfaZ25bEr8Vo+qD49k/mZATEd0X0WwzxrJE/0WP2kbHDQKCplGFUFoAmT1BrDUsXrc19cmi3VpYW1NlXmYzUc+fxHKZxhg8H2SfmxiBXd232UJMwz8weAtVS/L95zvY2vbtrnG9qWXiIeIhje3FmQdFPUa8xQpC1kgVB3xZ7PZ/M7xLBnf7o54sAqXygd+R0REUPUJYP3/hX/41U1S5Q/DY/+qK+kfkdrdoPU7I9oU/zMhoY9DeZYMoK8GNc7wKdoOHNjjXG2AFWQidPT833yrsxDaGMLQ09THlfbbM3KR+MNaFGXf7iVPGOvDY9zHSU/WXi3gW9jlbXwTv9zRn+bAn95OJnHULqsTJsAXUW6DazH86+YQn+9FlYo+ldz5+151mwfwqE/D8G6WINORCmNyftQ2pN+IY87+Rp61liNn4KR8UVlZcfyo4u8rLy9ovIrgVluYgLM2l2z/6ahcoNGSiBYJQ5iPSinBi2pFE4fAm6AjeUfyUpZfmeLEmSIrefhvjosXrQl2wBQTRSGnjKP630+wfNzNNvjwkT26k1z/6deXNsw4pvgvEe2E/l7nKgqgqy1T4U5RKyYRHd/9vYFLyypO2KdtZlwJnkK6zsU9vPDLd+uHo8vEK6VzOQhvkS+wBMviZFYfQncQFfemEUoYZEsZ/ytgkE+w7RDFPhJ5EDolVjSxIkmxaGfCznvt5zSLMLZFR5In/ken9uPvvx26f/UadwEm58KDRdmfzD3Whz++VQRLErh6dFT4njKsg4yH9SKpL73co4rNtyZ256AFa6Ta1KKml8D5vGsa8x8mQ9VLAQTIHPkiaOdR1cv7etWGqSkkUYKbBv0vcy3ZHM+X8EvDJAup08qTbfuU5t+61N5eb3WyV1b0/6PO/Ac0r7jHbpOMssCm/eB+YSR77EijYnDFoLp3NBSvtEX9s1KN+jRXae4IiEV4vxCbSpTX1rox2ufVNypQXk9NDsjkUR7l/Hfl83Kc1/26QiHFIshzgvi/nJtkcu6ck/DZPZVhu+Za58hdG9TP3Gd+JVNpmEsg7+/btYC7R1ahQb9TgAAAAAAAAA==" style="width:50px;height:50px;border-radius:10px;"/>
</div>
<div>
<div class="title">SiMISA</div>
<div class="subtitle">Aplikasi Peminjaman Aset Sekolah.</div>
<div class="subtitle">Oleh : Twin Insani, S.Kom.</div>
</div>
</div>
<div class="header-actions">
</div>
</header>
<main class="main">
<nav aria-label="Main tabs" class="tabs" role="tablist">
<button aria-selected="true" class="tab active" data-tab="dashboard" role="tab">Dasbor</button>
<button class="tab" data-tab="manage" role="tab">Kelola Barang</button>
<button class="tab" data-tab="borrow" role="tab">Pinjam</button>
<button class="tab" data-tab="return" role="tab">Kembalikan</button>
<button class="tab" data-tab="history" role="tab">Riwayat</button>
<button class="tab" data-tab="backup" role="tab">Managemen Data</button></nav>
<section class="view" id="dashboard" role="tabpanel">
<div aria-hidden="false" class="stats">
<div class="stat"><div class="n" id="totalN">0</div><div class="label">Total</div></div>
<div class="stat"><div class="n" id="availN">0</div><div class="label">Tersedia</div></div>
<div class="stat"><div class="n" id="borrowedN">0</div><div class="label">Dipinjam</div></div>
</div>
<div class="search">
<input aria-label="Cari barang" id="q" placeholder="Cari barang, kategori, peminjam..." type="search"/>
<button class="btn ghost" id="clearSearch" title="Hapus pencarian">Bersihkan</button>
</div>
<div class="actions" id="dashboardFilters" style="margin-bottom:10px; gap:5px; flex-wrap:wrap">
<button class="btn ghost active" data-dash-filter="all" type="button">Semua</button>
<button class="btn ghost" data-dash-filter="available" type="button">Tersedia</button>
<button class="btn ghost" data-dash-filter="borrowed" type="button">Dipinjam</button>
</div>
<div aria-live="polite" class="list" id="items"></div>
</section>
<section class="view" hidden="" id="manage">
<div class="meta" style="font-weight:bold;margin-bottom:5px;font-size:1.1em;color:#22c55e;">📦 Tambah Barang Baru</div>
<div style="background:#ffffff;border:1px solid #ddd;padding:10px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:10px;">
<form autocomplete="off" class="form" id="addForm">
<input class="input" id="name" placeholder="Nama barang" required="" type="text"/>
<input class="input" id="category" placeholder="Kategori (opsional)" type="text"/>
<input class="input" id="desc" placeholder="Deskripsi singkat (opsional)" type="text"/>
<div class="hr"></div>
<button class="btn primary" type="submit">Tambah barang</button>
</form>
</div>
<div class="hr"></div>
<div class="search">
<input aria-label="Cari barang" id="manageSearch" placeholder="Cari barang..." type="search"/>
<button class="btn ghost" id="clearManageSearch" title="Hapus pencarian">Bersihkan</button>
</div>
<div class="actions" style="margin-bottom:10px; gap:5px; flex-wrap:wrap">
<button class="btn ghost" data-filter="all" type="button">Semua</button>
<button class="btn ghost" data-filter="available" type="button">Tersedia</button>
<button class="btn ghost" data-filter="borrowed" type="button">Dipinjam</button>
</div>
<div class="list" id="manageList"></div>
</section>
<section class="view" hidden="" id="borrow">
<form class="form" id="borrowForm">
<select class="select" id="borrowSelect" required="">
<option value="">Pilih barang yang tersedia…</option>
</select>
<input class="input" id="borrower" placeholder="Nama peminjam" required="" type="text"/>
<label for="borrowDate" style="display:block;margin-bottom:4px;">Tanggal pinjam</label><input class="input" id="borrowDate" required="" type="date"/>
<label for="expectedReturn" style="display:block;margin-bottom:4px;">Perkiraan pengembalian</label><input class="input" id="expectedReturn" min="2025-08-12" placeholder="Perkiraan pengembalian (opsional)" type="date"/>
<div class="photo-upload-container" id="borrowPhotoContainer">
<input accept="image/*" capture="environment" id="borrowPhoto" name="borrowPhoto" type="file"/>
<div class="upload-placeholder">
<div class="upload-icon">📷</div>
<p>Tambah Foto</p>
<small>Ketuk untuk memotret atau pilih</small>
</div>
<div class="photo-preview" id="borrowPreview"></div>
</div>
<div class="hr"></div>
<button class="btn primary" type="submit">Catat peminjaman</button>
</form>
</section>
<section class="view" hidden="" id="return">
<form class="form" id="returnForm">
<select class="select" id="returnSelect" required="">
<option value="">Pilih barang yang dipinjam…</option>
</select>
<label for="returnDate" style="display:block;margin-bottom:4px;">Tanggal kembali</label><input class="input" id="returnDate" required="" type="date">
<div class="photo-upload-container" id="returnPhotoContainer">
<input accept="image/*" capture="environment" id="returnPhoto" name="returnPhoto" type="file"/>
<div class="upload-placeholder">
<div class="upload-icon">📷</div>
<p>Tambah Foto</p>
<small>Ketuk untuk memotret atau pilih</small>
</div>
<div class="photo-preview" id="returnPreview"></div>
</div>
<div class="hr"></div>
<button class="btn primary" type="submit">Catat pengembalian</button>
</input></form>
</section>
<section class="view" hidden="" id="history">
<div class="actions" style="margin-bottom:10px">
<input class="input" id="historyMonth" style="max-width:200px" type="month">
<button class="btn ghost" id="clearMonth">Bersihkan</button>
<button class="btn ghost" id="exportMonthPdf">Ekspor PDF</button>
</input></div>
<div class="list" id="historyList"></div>
</section>
<section class="view" hidden="" id="backup"><div class="actions"><button class="btn ghost" id="exportBtn" title="Ekspor data">Ekspor</button><button class="btn ghost" id="importBtn" title="Impor data">Impor</button><button class="btn ghost" id="clearAll">Hapus semua</button></div></section></main>
<footer class="footer">
<div class="small">Data disimpan di browser Anda (localStorage). Dapat digunakan tanpa internet.</div>
</footer>
</div>
<script>
/*
  Careful, incremental optimization:
  - LRU photo cache (limits memory)
  - Object URL management (revoke on eviction)
  - Batched photo fetching for responsiveness
  - Chunked DOM rendering with cancellation token to avoid blocking
  - Bugfixes: removed references to undefined variables and corrected cache clearing
  - Defensive try/catch on async operations to avoid fatal exceptions
*/

const DB_NAME = 'simisa_photos';
const DB_STORE = 'photos';
let db;
function openDB(){ return new Promise((resolve,reject)=>{ const req = indexedDB.open(DB_NAME,1); req.onupgradeneeded = e=>{ db = e.target.result; if(!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE); }; req.onsuccess = e=>{ db = e.target.result; resolve(db); }; req.onerror = e=> reject(e); }); }
async function putPhoto(id, blob){ if(!db) await openDB(); return new Promise((resolve,reject)=>{ const tx = db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).put(blob, id); tx.oncomplete = ()=> resolve(id); tx.onerror = e=> reject(e); }); }
async function getPhoto(id){ if(!db) await openDB(); return new Promise((resolve,reject)=>{ const tx = db.transaction(DB_STORE,'readonly'); const req = tx.objectStore(DB_STORE).get(id); req.onsuccess = ()=> resolve(req.result || null); req.onerror = e=> reject(e); }); }

/* --- Photo caching with LRU and object URL management --- */
const PHOTO_CACHE_LIMIT = 50;
const photoCache = new Map(); // id -> Blob
const urlCache = new Map();   // id -> objectURL

function _ensureCacheLimit(){
  while(photoCache.size > PHOTO_CACHE_LIMIT){
    const oldestKey = photoCache.keys().next().value;
    photoCache.delete(oldestKey);
    const url = urlCache.get(oldestKey);
    if(url){ try{ URL.revokeObjectURL(url); }catch(e){} urlCache.delete(oldestKey); }
  }
}

async function getCachedPhoto(id){
  if(!id) return null;
  if(photoCache.has(id)){
    const val = photoCache.get(id);
    // move to end (LRU)
    photoCache.delete(id);
    photoCache.set(id, val);
    return val;
  }
  try{
    const blob = await getPhoto(id);
    if(blob){
      photoCache.set(id, blob);
      _ensureCacheLimit();
      return blob;
    }
    return null;
  }catch(err){
    console.error('getCachedPhoto failed', err);
    return null;
  }
}

function getObjectURLFor(id, blob){
  if(!id || !blob) return null;
  if(urlCache.has(id)) return urlCache.get(id);
  try{
    const u = URL.createObjectURL(blob);
    urlCache.set(id, u);
    return u;
  }catch(err){
    console.error('createObjectURL failed', err);
    return null;
  }
}

function clearPhotoCache(){
  for(const u of urlCache.values()){
    try{ URL.revokeObjectURL(u); }catch(e){}
  }
  photoCache.clear();
  urlCache.clear();
}

/* --- Utilities --- */
const $ = sel => document.querySelector(sel);
const el = id => document.getElementById(id);
const STORAGE_KEY = 'simisa_v1';

let state = { items: [], history: [] };

/* safe JSON load */
function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) state = JSON.parse(raw); else { state.items = [ { id:'itm-1', name:'MacBook Pro', category:'Electronics', desc:'13-inch', status:'available'}, { id:'itm-2', name:'Cordless Drill', category:'Tools', desc:'Battery powered', status:'borrowed', borrowedBy:'John', borrowDate:'2025-08-05', expectedReturn:'2025-08-10'} ]; state.history = []; save(); } }catch(e){ console.error(e); state = {items:[], history:[]}; } }
function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.error('save failed', e); } }

function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,9); }
function formatDate(s){ if(!s) return ''; const d = new Date(s); if(isNaN(d)) return s; return d.toLocaleDateString('id-ID'); }
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function downloadText(filename, text){ const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([text], {type:'application/json'})); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); try{ URL.revokeObjectURL(a.href); }catch(e){} }

function showView(id){
  document.querySelectorAll('.view').forEach(v => v.hidden = true);

  const target = document.getElementById(id);
  if (target) {
    target.hidden = false;
    target.classList.add('fade-in');
    setTimeout(() => target.classList.remove('fade-in'), 400);
  }

  document.querySelectorAll('.tab').forEach(t =>
    t.classList.toggle('active', t.dataset.tab===id)
  );

  const today = new Date().toISOString().split('T')[0];

  if (id === 'borrow') {
    el('borrowDate').value = today;
    el('borrowDate').readOnly = true;
    el('expectedReturn').value = today;
    resetPhotoFrame('borrowPhotoContainer', 'borrowPhoto', 'borrowPreview'); // clear borrow photo // always default to today

    // CLEAR the borrower name field every time switch to borrow tab
    if (el('borrower')) el('borrower').value = '';
  }
  if (id === 'return') {
    el('returnDate').value = today;
    el('returnDate').readOnly = true;
    resetPhotoFrame('returnPhotoContainer', 'returnPhoto', 'returnPreview'); // clear return photo
  }
  if(id==='borrow' || id==='return') populateSelects();
  
  if(id==='manage'){
    if(el('manageSearch')) el('manageSearch').value = '';
    manageFilter = 'all';
    renderManage();
    if(!document.body.dataset.manageBound){
      document.querySelectorAll('#manage [data-filter]').forEach(btn => {
        btn.addEventListener('click', ()=> { 
          manageFilter = btn.dataset.filter; 
          renderManage(); 
        });
      });
      if(el('manageSearch')) el('manageSearch').addEventListener('input', ()=> renderManage());
      document.body.dataset.manageBound = '1';
    }
  }
}



/* --- UI rendering with chunking and cancellation tokens --- */
const renderTokens = {};

function cancelRender(key){
  renderTokens[key] = (renderTokens[key] || 0) + 1;
}

function getRenderToken(key){ return (renderTokens[key] || 0) + 1; }

/* chunked render helper */
async function renderInBatches(key, items, batchSize, renderFn, container){
  const token = getRenderToken(key);
  renderTokens[key] = token;
  container.innerHTML = '';
  const frag = document.createDocumentFragment();
  for(let i=0;i<items.length;i++){
    if(renderTokens[key] !== token) return; // cancelled
    const node = renderFn(items[i], i);
    frag.appendChild(node);
    if((i+1) % batchSize === 0){
      container.appendChild(frag);
      // small pause to keep UI responsive
      await new Promise(r => setTimeout(r, 0));
    }
  }
  if(renderTokens[key] === token) container.appendChild(frag);
}

/* Render parts */
function renderStats(){
  const total = state.items.length;
  const avail = state.items.filter(i=>i.status==='available').length;
  const borrowed = state.items.filter(i=>i.status==='borrowed').length;
  el('totalN').textContent = total;
  el('availN').textContent = avail;
  el('borrowedN').textContent = borrowed;
}

/* helper: fetch blobs in batches (keeps UI responsive & avoids too many concurrent IDB reads) */
async function fetchBlobsInBatches(ids, batchSize = 8){
  const results = new Array(ids.length).fill(null);
  for(let i=0;i<ids.length;i+=batchSize){
    const slice = ids.slice(i, i+batchSize);
    const promises = slice.map(id => id ? getCachedPhoto(id) : Promise.resolve(null));
    try{
      const res = await Promise.all(promises);
      for(let j=0;j<res.length;j++) results[i+j] = res[j];
    }catch(err){
      console.error('batch photo fetch error', err);
      for(let j=0;j<slice.length;j++) results[i+j] = null;
    }
    // yield
    await new Promise(r => setTimeout(r, 0));
  }
  return results;
}

async function renderDashboardList(){
  const itemsWrap = el('items');
  const q = el('q').value.trim().toLowerCase();
  const list = state.items.filter(it => {
    if (dashboardFilter !== 'all' && it.status !== dashboardFilter) return false;
    if(!q) return true;
    return (it.name||'').toLowerCase().includes(q) || (it.category||'').toLowerCase().includes(q) || (it.desc||'').toLowerCase().includes(q) || (it.borrowedBy||'').toLowerCase().includes(q);
  });

  if(list.length===0){
    itemsWrap.innerHTML = '<div class="card"><div class="meta">No items found — add one.</div></div>';
    return;
  }

  // prepare photo fetches in batches
  const photoIds = list.map(it => it.photo || null);
  const blobs = await fetchBlobsInBatches(photoIds, 10);

  const renderFn = (it, idx) => {
    const blob = blobs[idx];
    const card = document.createElement('div'); card.className = 'card ' + (it.status === 'available' ? 'available' : 'borrowed'); card.dataset.id = it.id;
    const top = document.createElement('div'); top.className='top';
    top.appendChild(document.createElement('div')).textContent = it.category || '';
    const badge = document.createElement('div'); badge.className = 'badge ' + (it.status==='available'?'available':'borrowed');
    badge.textContent = it.status==='available' ? 'Tersedia' : 'Dipinjam';
    top.appendChild(badge);
    card.appendChild(top);
    const h = document.createElement('h3'); h.textContent = it.name; card.appendChild(h);
    const p = document.createElement('div'); p.className='meta'; p.textContent = it.desc || ''; card.appendChild(p);

    if(it.status==='borrowed'){
      const by = document.createElement('div'); by.className='meta'; by.textContent = `Dipinjam oleh: ${it.borrowedBy} • ${formatDate(it.borrowDate)} ${it.expectedReturn? '• perkiraan: ' + formatDate(it.expectedReturn):''}`;
      card.appendChild(by);
    }

    if(blob){
      const preview = document.createElement('div'); preview.className='preview';
      const img = document.createElement('img'); img.loading='lazy';
      const url = getObjectURLFor(it.photo, blob);
      img.src = url || '';
      img.alt = it.name + ' photo'; img.style.maxHeight='220px'; img.style.objectFit='cover';
      img.addEventListener('click', ()=> openImageModal(url));
      preview.appendChild(img); card.appendChild(preview);
    }

    const actions = document.createElement('div'); actions.className='actions';

    if(it.status==='available'){
      const borrowBtn = document.createElement('button'); borrowBtn.className='btn primary'; borrowBtn.textContent='Pinjam';
      borrowBtn.dataset.action = 'borrow'; borrowBtn.dataset.id = it.id;
      actions.appendChild(borrowBtn);
    } else {
      const returnBtn = document.createElement('button'); returnBtn.className='btn borrowed-return'; returnBtn.textContent='Tandai dikembalikan';
      returnBtn.dataset.action = 'return'; returnBtn.dataset.id = it.id;
      actions.appendChild(returnBtn);
    }
    card.appendChild(actions);
    return card;
  };

  await renderInBatches('dashboard', list, 20, renderFn, itemsWrap);
}

async function renderHistoryList(){
  const historyWrap = el('historyList'); historyWrap.innerHTML='';
  const selectedMonth = el('historyMonth')?.value || '';
  let historyData = state.history.slice().reverse();
  if (selectedMonth) {
    historyData = historyData.filter(h => {
      const date = new Date(h.date);
      const monthStr = date.toISOString().slice(0, 7);
      return monthStr === selectedMonth;
    });
  }
  if(historyData.length===0){ historyWrap.innerHTML = '<div class="card"><div class="meta">Tidak ada riwayat untuk bulan ini.</div></div>'; return; }

  const photoIds = historyData.map(h => h.photo || null);
  const blobs = await fetchBlobsInBatches(photoIds, 10);

  const renderFn = (h, idx) => {
    const blob = blobs[idx];
    const c = document.createElement('div'); c.className='card';
    const t = document.createElement('div'); t.className='meta'; t.textContent = `${h.action.toUpperCase()} • ${h.itemName} • ${h.by || h.borrower || ''} • ${formatDate(h.date)}`;
    c.appendChild(t);
    if(blob){
      const pv = document.createElement('div'); pv.className='preview';
      const im = document.createElement('img'); im.loading='lazy';
      const url = getObjectURLFor(h.photo, blob);
      im.src = url || '';
      im.alt='photo'; im.style.maxHeight='180px'; im.style.objectFit='cover';
      im.addEventListener('click', ()=> openImageModal(url));
      pv.appendChild(im); c.appendChild(pv);
    }
    return c;
  };

  await renderInBatches('history', historyData, 20, renderFn, historyWrap);
}

function populateSelects(){
  const borrowSel = el('borrowSelect'); borrowSel.innerHTML = '<option value="">Pilih barang yang tersedia…</option>';
  const returnSel = el('returnSelect'); returnSel.innerHTML = '<option value="">Pilih barang yang dipinjam…</option>';
  for(const it of state.items){
    if(it.status==='available') borrowSel.insertAdjacentHTML('beforeend', `<option value="${it.id}">${escapeHtml(it.name)} ${it.category? ' ('+escapeHtml(it.category)+')':''}</option>`);
    if(it.status==='borrowed') returnSel.insertAdjacentHTML('beforeend', `<option value="${it.id}">${escapeHtml(it.name)} — ${escapeHtml(it.borrowedBy||'')}</option>`);
  }
}

/* Render Manage Items with delegation-friendly buttons */
let manageFilter = 'all';
let dashboardFilter = 'all';
function renderManage(highlightId=null){
  const wrap = el('manageList'); wrap.innerHTML='';
  let items = [...state.items];
  if(manageFilter !== 'all') items = items.filter(it => it.status === manageFilter);
  const query = el('manageSearch')?.value.trim().toLowerCase() || '';
  if(query) items = items.filter(it => (it.name || '').toLowerCase().includes(query) || (it.category || '').toLowerCase().includes(query) || (it.desc || '').toLowerCase().includes(query));
  if(items.length === 0){ wrap.innerHTML = '<div class="card"><div class="meta">No items to manage.</div></div>'; return; }

  const newest = items[items.length - 1];
  const sorted = items.slice(0, -1).sort((a,b) => (a.name || '').localeCompare(b.name || ''));
  const finalList = newest ? [newest, ...sorted] : sorted;

  const frag = document.createDocumentFragment();

  for(const it of finalList){
    const card = document.createElement('div'); card.className = 'card ' + (it.status === 'available' ? 'available' : 'borrowed'); card.dataset.id = it.id;
    if(highlightId && it.id === highlightId){ card.style.backgroundColor = '#d1fae5'; setTimeout(()=>{ card.style.backgroundColor=''; }, 3000); }
    const top = document.createElement('div'); top.className='top';
    top.appendChild(document.createElement('div')).textContent = it.category || '';
    const badge = document.createElement('div'); badge.className = 'badge ' + (it.status==='available'?'available':'borrowed');
    badge.textContent = it.status==='available' ? 'Tersedia' : 'Dipinjam';
    top.appendChild(badge); card.appendChild(top);
    const h = document.createElement('h3'); h.textContent = it.name; card.appendChild(h);
    const p = document.createElement('div'); p.className='meta'; p.textContent = it.desc || ''; card.appendChild(p);

    if(it.status === 'available'){
      const actions = document.createElement('div'); actions.className='actions';
      const editBtn = document.createElement('button'); editBtn.className='btn primary'; editBtn.textContent='Ubah'; editBtn.dataset.action='edit'; editBtn.dataset.id = it.id;
      const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='Hapus'; delBtn.dataset.action='delete'; delBtn.dataset.id = it.id;
      actions.appendChild(editBtn); actions.appendChild(delBtn); card.appendChild(actions);
    }
    frag.appendChild(card);
  }

  wrap.appendChild(frag);
}

/* Photo processing (unchanged core but with safe guards) */
function resizeImage(file, maxW, maxH){ return new Promise((resolve)=>{ const img = new Image(); const reader = new FileReader(); reader.onload = e=>{ img.onload = ()=>{ const canvas = document.createElement('canvas'); let { width, height } = img; if (width > maxW || height > maxH){ const scale = Math.min(maxW / width, maxH / height); width *= scale; height *= scale; } canvas.width = width; canvas.height = height; canvas.getContext('2d').drawImage(img, 0, 0, width, height); let quality = 0.8; if (file.size > 2 * 1024 * 1024) quality = 0.6; else if (file.size > 1 * 1024 * 1024) quality = 0.7; resolve(canvas.toDataURL('image/webp', quality)); }; img.onerror = ()=> resolve(null); img.src = e.target.result; }; reader.onerror = ()=> resolve(null); reader.readAsDataURL(file); }); }

async function processPhotoInput(file, previewEl) {
  try{
    if (!file) return null;
    if (file.size > 5 * 1024 * 1024) { alert('Maks 5MB'); return null; }
    const resizedData = await resizeImage(file, 1024, 1024);
    if(!resizedData) return null;
    const blob = await (await fetch(resizedData)).blob();
    const photoId = 'photo_' + uid();
    await putPhoto(photoId, blob);
    // Use object URL for preview and cache both blob & url
    photoCache.set(photoId, blob);
    const url = getObjectURLFor(photoId, blob);
    previewEl.innerHTML = `<img`;
        if (typeof showToast === 'function') { showToast('Foto ditambahkan'); }
        previewEl.innerHTML = `<img src="${url}" alt="preview">`;
    previewEl.hidden = false;
    _ensureCacheLimit();
    return photoId;
  }catch(err){
    console.error('processPhotoInput failed', err);
    return null;
  }
}

/* --- Event wiring (one-time) --- */
document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', e=> { showView(t.dataset.tab); }));
if(el('q')) el('q').addEventListener('input', throttle(()=> renderDashboardList(), 180));
el('clearSearch').addEventListener('click', ()=> { el('q').value=''; renderDashboardList(); });

document.querySelectorAll('#dashboardFilters [data-dash-filter]').forEach(btn => {
  btn.addEventListener('click', () => {
    dashboardFilter = btn.dataset.dashFilter;
    document.querySelectorAll('#dashboardFilters .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderDashboardList();
  });
});

if(el('addForm')) el('addForm').addEventListener('submit', e=> { e.preventDefault(); try{ const name = el('name').value.trim(); if(!name) return alert('Masukkan nama'); const item = { id: uid('itm'), name, category: el('category').value.trim(), desc: el('desc').value.trim(), status:'available' }; state.items.unshift(item); save(); el('addForm').reset(); renderManage(item.id); renderStats(); renderDashboardList(); showToast('Barang ditambahkan', 'success'); }catch(err){ console.error(err); showToast('Gagal menambah barang','danger'); } });

/* Borrow/Return forms */
if(el('borrowForm')) el('borrowForm').addEventListener('submit', async e=> {
  e.preventDefault();
  try{
    const id = el('borrowSelect').value; if(!id) return alert('Pilih barang');
    const borrower = el('borrower').value.trim(); if(!borrower) return alert('Masukkan nama peminjam');
    const bDate = new Date().toISOString().split('T')[0];
    const exp = el('expectedReturn').value || '';
    const photoId = el('borrowPhoto').dataset.photoId || null;
    if (!photoId) return showToast('Harap ambil foto saat meminjam', 'warning');
    const item = state.items.find(x=>x.id===id);
    if (!item) return alert('Barang tidak ditemukan');
    item.status = 'borrowed'; item.borrowedBy = borrower; item.borrowDate = bDate; item.expectedReturn = exp; if (photoId) item.photo = photoId;
    state.history.push({ action: 'borrowed', itemId: id, itemName: item.name, borrower, date: bDate, expectedReturn: exp || '', photo: photoId || item.photo || null });
    save();
    el('borrowForm').reset(); el('borrowPreview').hidden = true;
    populateSelects();
    renderStats(); await renderDashboardList(); renderHistoryList();
    showView('dashboard');
    showToast('Peminjaman tercatat');
    resetPhotoFrame('borrowPhotoContainer','borrowPhoto','borrowPreview', 'success');
  }catch(err){
    console.error(err);
    showToast('Gagal mencatat peminjaman','danger');
  }
});

if(el('returnForm')) el('returnForm').addEventListener('submit', async e=> {
  e.preventDefault();
  try{
    const id = el('returnSelect').value; if(!id) return alert('Pilih barang');
    const rDate = new Date().toISOString().split('T')[0];
    const photo = el('returnPhoto').dataset.photoId || null;
    if (!photo) return showToast('Harap ambil foto saat pengembalian', 'warning');
    const item = state.items.find(x=>x.id===id); if(!item) return alert('Barang tidak ditemukan');
    state.history.push({ action:'returned', itemId:id, itemName:item.name, borrower: item.borrowedBy || null, date:rDate, photo });
    item.status='available'; item.borrowedBy=null; item.borrowDate=null; item.expectedReturn=null; if(photo) item.photo = photo;
    save();
    el('returnForm').reset(); el('returnPreview').hidden=true;
    populateSelects();
    renderStats(); await renderDashboardList(); renderHistoryList();
    showView('dashboard');
    showToast('Pengembalian tercatat');
    resetPhotoFrame('returnPhotoContainer','returnPhoto','returnPreview', 'success');
  }catch(err){
    console.error(err);
    showToast('Gagal mencatat pengembalian','danger');
  }
});

/* Photo inputs */
if(el('borrowPhoto')) el('borrowPhoto').addEventListener('change', async e => {
  const photoId = await processPhotoInput(e.target.files[0], el('borrowPreview'));
  e.target.dataset.photoId = photoId || '';
  // scroll into view in a safe way
  const btn = document.querySelector('#borrowForm button[type="submit"]');
  const img = el('borrowPreview')?.querySelector('img');
  const doScroll = () => {
    if (btn) { try { btn.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (err) { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); } }
  };
  if (img) {
    if (img.complete) doScroll();
    else {
      img.addEventListener('load', doScroll, { once: true });
      setTimeout(doScroll, 500);
    }
  } else { setTimeout(doScroll, 200); }
});

if(el('returnPhoto')) el('returnPhoto').addEventListener('change', async e => {
  const photoId = await processPhotoInput(e.target.files[0], el('returnPreview'));
  e.target.dataset.photoId = photoId || '';
  const btn = document.querySelector('#returnForm button[type="submit"]');
  const img = el('returnPreview')?.querySelector('img');
  const doScroll = () => {
    if (btn) { try { btn.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (err) { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); } }
  };
  if (img) {
    if (img.complete) doScroll();
    else {
      img.addEventListener('load', doScroll, { once: true });
      setTimeout(doScroll, 500);
    }
  } else { setTimeout(doScroll, 200); }
});

/* history month */
if(el('historyMonth')) el('historyMonth').addEventListener('input', ()=> { renderHistoryList(); });
if(el('clearMonth')) el('clearMonth').addEventListener('click', () => { el('historyMonth').value = ''; renderHistoryList(); });

/* export/import/clear (improved backup handling) */
if(el('exportMonthPdf')) el('exportMonthPdf').addEventListener('click', ()=> {
  try{
    const selectedMonth = el('historyMonth').value;
    if (!selectedMonth) { return alert('Silakan pilih bulan terlebih dahulu.'); }

    const [year, month] = selectedMonth.split('-');
    const monthName = new Date(`${selectedMonth}-01`).toLocaleString('id-ID', { month: 'long' });
    const titleText = `Riwayat Peminjaman Barang — ${monthName} ${year}`;

    const monthData = state.history.filter(h => { 
      const date = new Date(h.date); 
      return date.toISOString().slice(0, 7) === selectedMonth; 
    }).sort((a,b) => new Date(a.date) - new Date(b.date));

    if (monthData.length === 0) { return alert('Tidak ada data untuk bulan ini.'); }

    const merged = []; const usedIndexes = new Set();
    monthData.forEach((entry, idx) => {
      if (usedIndexes.has(idx)) return;
      if (entry.action === 'borrowed') {
        const matchIdx = monthData.findIndex((x, i) => i > idx && x.action === 'returned' && x.itemName === entry.itemName && (x.by || x.borrower) === (entry.by || entry.borrower));
        if (matchIdx !== -1) {
          merged.push({ name: entry.by || entry.borrower || '', itemName: entry.itemName, borrowedDate: formatDate(entry.date), expectedReturn: formatDate(entry.expectedReturn || ''), returnedDate: formatDate(monthData[matchIdx].date), action: 'returned' });
          usedIndexes.add(matchIdx);
        } else {
          merged.push({ name: entry.by || entry.borrower || '', itemName: entry.itemName, borrowedDate: formatDate(entry.date), expectedReturn: formatDate(entry.expectedReturn || ''), returnedDate: '', action: 'borrowed' });
        }
        usedIndexes.add(idx);
      } else if (entry.action === 'returned') {
        const matchIdx = monthData.findIndex((x, i) => i < idx && x.action === 'borrowed' && x.itemName === entry.itemName && (x.by || x.borrower) === (entry.by || entry.borrower));
        if (matchIdx === -1) {
          merged.push({ name: entry.by || entry.borrower || '', itemName: entry.itemName, borrowedDate: '', expectedReturn: '', returnedDate: formatDate(entry.date), action: 'returned' });
          usedIndexes.add(idx);
        }
      }
    });

    let html = `<h2 style="text-align:center;margin-bottom:15px;">${titleText}</h2>
    <table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;width:100%">
    <tr><th>Name</th><th>Item Name</th><th>Borrowed Date</th><th>Perkiraan pengembalian</th><th>Returned Date</th><th>Action</th></tr>`;

    merged.forEach(h => { 
      html += `<tr>
        <td>${h.name}</td>
        <td>${h.itemName}</td>
        <td>${h.borrowedDate}</td>
        <td>${h.expectedReturn || ''}</td>
        <td>${h.returnedDate}</td>
        <td>${h.action==='returned' ? 'Dikembalikan' : 'Dipinjam'}</td>
      </tr>`; 
    });
    html += `</table>`;

    const printWin = window.open('', '_blank'); 
    printWin.document.write(`<html><head><title>${titleText}</title></head><body>${html}</body></html>`); 
    printWin.document.close(); 
    printWin.focus(); 
    printWin.print();
  }catch(err){
    console.error(err);
    alert('Gagal mengekspor PDF');
  }
});

if(el('exportBtn')) el('exportBtn').addEventListener('click', ()=> { try{ const data = JSON.stringify(state, null, 2); downloadText('simisa-export.json', data); showToast('Berhasil mengekspor JSON', 'success'); }catch(err){ console.error(err); showToast('Gagal mengekspor','danger'); } });

/* Full backup (state + IndexedDB photos) */
async function exportFullBackup(){
  try{
    const date = new Date();
    const dd = String(date.getDate()).padStart(2,'0');
    const mm = String(date.getMonth()+1).padStart(2,'0');
    const yyyy = date.getFullYear();
    const filename = `SiMISA_backup_${dd}-${mm}-${yyyy}.json`;

    const ids = new Set();
    state.items.forEach(it => { if(it.photo) ids.add(it.photo); });
    state.history.forEach(h => { if(h.photo) ids.add(h.photo); });
    const idList = Array.from(ids);
    const total = idList.length;
    if(total === 0){
      const backupData = { state, photos: {} };
      downloadText(filename, JSON.stringify(backupData));
      showToast('Managemen Data selesai (tanpa foto)', 'success');
      return;
    }

    showToast(`Mencadangkan foto 0/${total}`, 'info');
    const blobPromises = idList.map(id => getCachedPhoto(id));
    const blobs = await Promise.all(blobPromises);

    const toDataURL = blob => new Promise(res => {
      if(!blob){ res(null); return; }
      const reader = new FileReader();
      reader.onload = e => res(e.target.result);
      reader.readAsDataURL(blob);
    });
    const dataUrlPromises = blobs.map(b => toDataURL(b));
    const dataUrls = await Promise.all(dataUrlPromises);

    const photos = {};
    for(let i=0;i<idList.length;i++){
      if(dataUrls[i]) photos[idList[i]] = dataUrls[i];
      showToast(`Mencadangkan foto ${i+1}/${total}`, 'info');
      await new Promise(r => setTimeout(r, 0));
    }

    const backupData = { state, photos };
    const sizeMB = (new Blob([JSON.stringify(backupData)]).size / (1024*1024)).toFixed(2);
    downloadText(filename, JSON.stringify(backupData));
    setTimeout(function(){ showToast(`Full backup complete (Size: ${sizeMB} MB)`, 'success'); }, 800);
  }catch(err){
    console.error('exportFullBackup failed', err);
    showToast('Managemen Data gagal', 'danger');
  }
}

async function importFullBackup(){
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = async e => {
    const f = e.target.files[0];
    if(!f) return;
    const text = await f.text();
    let parsed;
    try{ parsed = JSON.parse(text); } catch(err){ alert('Invalid JSON'); return; }
    if(!parsed.state || !parsed.photos){ alert('Invalid backup file'); return; }
    // restore state
    state = parsed.state;
    save();
    // restore photos to IndexedDB: clear store then put photos
    if(!db) await openDB();
    const tx = db.transaction(DB_STORE, 'readwrite');
    tx.objectStore(DB_STORE).clear();
    await new Promise(res => { tx.oncomplete = res; tx.onerror = ()=>res(); });

    const entries = Object.entries(parsed.photos || {});
    if(entries.length === 0){
      clearPhotoCache();
      await renderAll();
      showToast('Managemen Data diimpor (tanpa foto)', 'success');
      return;
    }

    showToast(`Memulihkan foto 0/${entries.length}`, 'info');
    const putPromises = entries.map(async ([id, dataUrl], idx) => {
      // convert dataURL -> blob then put
      const resp = await fetch(dataUrl);
      const blob = await resp.blob();
      await putPhoto(id, blob);
      // prime local caches
      photoCache.set(id, blob);
      getObjectURLFor(id, blob);
      showToast(`Memulihkan foto ${idx+1}/${entries.length}`, 'info');
      await new Promise(r => setTimeout(r, 0));
    });
    await Promise.all(putPromises);
    clearPhotoCache(); // clear object URLs (they were created above to avoid leaks) and prime caches will be re-created on demand
    await renderAll();
    setTimeout(function(){ showToast('Managemen Data lengkap dipulihkan', 'success'); }, 800);
  };
  inp.click();
}

/* Wire buttons to new functions (safe rebind) */
try{
  const exp = el('exportBtn');
  if(exp){
    exp.replaceWith(exp.cloneNode(true));
    el('exportBtn').addEventListener('click', exportFullBackup);
  }
  const imp = el('importBtn');
  if(imp){
    imp.replaceWith(imp.cloneNode(true));
    el('importBtn').addEventListener('click', importFullBackup);
  }
} catch(err){
  console.error('Failed to rebind backup buttons', err);
}

if (el('manageSearch')) {
  el('manageSearch').addEventListener('input', () => renderManage());
}
if (el('clearManageSearch')) {
  el('clearManageSearch').addEventListener('click', () => {
    el('manageSearch').value = '';
    renderManage();
  });
}

/* Hapus semua with safe cache cleanup */
if(el('clearAll')) el('clearAll').addEventListener('click', ()=> { if(confirm('Hapus semua data? This cannot be undone.')){ localStorage.removeItem(STORAGE_KEY); state = {items:[], history:[]}; save(); clearPhotoCache(); load(); renderAll(); showToast('Dihapus', 'danger'); } });

/* Event delegation for dashboard and manage lists */
if(el('items')) el('items').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action]'); if(!btn) return;
  const action = btn.dataset.action; const id = btn.dataset.id;
  if(action==='borrow'){ showView('borrow'); el('borrowSelect').value = id; }
  else if(action==='return'){ showView('return'); el('returnSelect').value = id; }
});

if(el('manageList')) el('manageList').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action]'); if(!btn) return;
  const action = btn.dataset.action; const id = btn.dataset.id;
  const item = state.items.find(x=>x.id===id);
  if(!item) return;
  if(action==='delete'){ if(confirm('Delete this item?')){ state.items = state.items.filter(x=>x.id!==id); save(); renderManage(); renderStats(); renderDashboardList(); showToast('Item deleted','danger'); } }
  else if(action==='edit'){
    // render inline edit form inside the card
    const card = btn.closest('.card'); card.innerHTML = `
      <div class="form">
        <input class="input" id="editName" value="${escapeHtml(item.name)}" placeholder="Nama barang" />
        <input class="input" id="editCategory" value="${escapeHtml(item.category||'')}" placeholder="Category" />
        <input class="input" id="editDesc" value="${escapeHtml(item.desc||'')}" placeholder="Description" />
        <select class="select" id="editStatus" disabled>
          <option value="available" ${item.status==='available'?'selected':''}>Tersedia</option>
          <option value="borrowed" ${item.status==='borrowed'?'selected':''}>Dipinjam</option>
        </select>
        <div class="actions">
          <button class="btn primary" data-action="save-edit" data-id="${id}">Simpan</button>
          <button class="btn ghost" data-action="cancel-edit" data-id="${id}">Batal</button>
        </div>
      </div>
    `;
  } else if(action==='save-edit' || action==='cancel-edit'){
    // handled by delegation below in same listener
  }
});

/* Handle save/cancel for inline edit via delegation (listen on manageList) */
if(el('manageList')) el('manageList').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action]'); if(!btn) return;
  const action = btn.dataset.action; const id = btn.dataset.id;
  if(action==='save-edit'){
    const card = btn.closest('.card'); const newName = card.querySelector('#editName').value.trim(); if(!newName) return alert('Nama wajib diisi');
    const it = state.items.find(x=>x.id===id); if(!it) return;
    it.name = newName; it.category = card.querySelector('#editCategory').value.trim(); it.desc = card.querySelector('#editDesc').value.trim();
    save(); renderManage(); renderStats(); renderDashboardList(); showToast('Item updated','success');
  } else if(action==='cancel-edit'){
    renderManage();
  }
});

/* small helpers */
function openImageModal(src){ 
  if(!src) return;
  const modal = document.createElement('div'); modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:9999';
  const img = document.createElement('img'); img.loading='lazy'; img.src=src; img.style.maxWidth='92%'; img.style.maxHeight='92%'; img.style.borderRadius='10px'; modal.appendChild(img); 
  modal.addEventListener('click', ()=> modal.remove()); 
  document.body.appendChild(modal); 
}

function showToast(msg, type = "info") {
  const styles = { info: { bg: "linear-gradient(90deg, var(--accent-1), var(--accent-2))", icon: "ℹ️" }, success: { bg: "linear-gradient(90deg, var(--success), #34d399)", icon: "✅" }, warning: { bg: "linear-gradient(90deg, var(--warning), #f97316)", icon: "⚠️" }, danger: { bg: "linear-gradient(90deg, var(--danger), #b91c1c)", icon: "❌" } };
  const t = document.createElement("div");
  t.innerHTML = `<span style="margin-right:8px">${styles[type]?.icon || styles.info.icon}</span>${msg}`;
  t.style.cssText = `position: fixed; left: 50%; transform: translateX(-50%) translateY(20px); bottom: 24px; background: ${styles[type]?.bg || styles.info.bg}; color: white; padding: 12px 18px; border-radius: 999px; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; box-shadow: 0 6px 18px rgba(0,0,0,0.25); z-index: 9999; opacity: 0; transition: all 0.35s ease; letter-spacing: 0.3px;`;
  document.body.appendChild(t);
  requestAnimationFrame(() => { t.style.opacity = 1; t.style.transform = "translateX(-50%) translateY(0)"; });
  setTimeout(() => { t.style.opacity = 0; t.style.transform = "translateX(-50%) translateY(20px)"; setTimeout(() => t.remove(), 5000); }, 2000);
}

/* throttle util */
function throttle(fn, wait){ let last=0, t; return (...args)=>{ const now = Date.now(); if(now - last > wait){ last = now; fn(...args); } else { clearTimeout(t); t = setTimeout(()=>{ last = Date.now(); fn(...args); }, wait - (now - last)); } }; }

/* top-level renderAll that calls the parts */
async function renderAll(){ try{ renderStats(); await renderDashboardList(); await renderHistoryList(); populateSelects(); renderManage(); }catch(err){ console.error('renderAll failed', err); } }

/* initial boot */
load();
renderAll();
showView('dashboard');

/* Set default month & dates */
const thisMonth = new Date().toISOString().slice(0, 7);
if (el('historyMonth')) el('historyMonth').value = thisMonth;


const today = new Date().toISOString().split('T')[0];
if(el('borrowDate')) el('borrowDate').value = today;
if(el('expectedReturn')) {
el('expectedReturn').value = today;
el('expectedReturn').setAttribute('min', today); // dynamically set min date
}
if(el('returnDate')) el('returnDate').value = today;


if(el('borrowDate')) el('borrowDate').addEventListener('change', e => {
if (!el('expectedReturn').dataset.manualChange) {
el('expectedReturn').value = e.target.value;
el('expectedReturn').setAttribute('min', e.target.value);
}
});
if(el('expectedReturn')) el('expectedReturn').addEventListener('change', () => {
el('expectedReturn').dataset.manualChange = true;
});

/* Full text import/export wires kept above */

/* make sure manage filter buttons are bound once */
if(!document.body.dataset.manageBound){
  document.querySelectorAll('#manage [data-filter]').forEach(btn => {
    btn.addEventListener('click', ()=> { 
      manageFilter = btn.dataset.filter; 
      renderManage(); 
    });
  });
  if(el('manageSearch')) el('manageSearch').addEventListener('input', ()=> renderManage());
  document.body.dataset.manageBound = '1';
}


// Enhance preview after processPhotoInput by adding remove button
function enhancePhotoPreview(containerId, inputId, previewId) {
    const container = document.getElementById(containerId);
    const inputEl = document.getElementById(inputId);
    const previewEl = document.getElementById(previewId);

    const observer = new MutationObserver(() => {
        if (previewEl.querySelector('img')) {
            container.classList.add('has-image');
            if (!container.querySelector('.btn-remove-photo')) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn-remove-photo';
                removeBtn.innerHTML = '&times;';
                removeBtn.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    ev.stopPropagation();
                    inputEl.value = '';
    inputEl.dataset.photoId = ''; // clear stored photo reference
                    inputEl.dataset.photoId = ''; // clear stored photo reference
                    previewEl.innerHTML = '';
                    container.classList.remove('has-image');
                });
                container.appendChild(removeBtn);
            }
        } else {
            container.classList.remove('has-image');
            const btn = container.querySelector('.btn-remove-photo');
            if (btn) btn.remove();
        }
    });
    observer.observe(previewEl, { childList: true });
}


function resetPhotoFrame(containerId, inputId, previewId) {
    const container = document.getElementById(containerId);
    const inputEl = document.getElementById(inputId);
    const previewEl = document.getElementById(previewId);
    inputEl.value = '';
    previewEl.innerHTML = '';
    container.classList.remove('has-image');
    const btn = container.querySelector('.btn-remove-photo');
    if (btn) btn.remove();
}

document.addEventListener('DOMContentLoaded', () => {
    enhancePhotoPreview('borrowPhotoContainer', 'borrowPhoto', 'borrowPreview');
    enhancePhotoPreview('returnPhotoContainer', 'returnPhoto', 'returnPreview');
});


// Reset Borrow/Return forms (except date fields)
function resetFormExceptDates(formId, containerId, inputId, previewId) {
    const form = document.getElementById(formId);
    if (form) {
        Array.from(form.elements).forEach(el => {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
                if (el.type !== 'date') {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = false;
                    } else if (el.type !== 'file') {
                        el.value = '';
                    }
                }
            }
        });
    }
    if (typeof resetPhotoFrame === 'function') {
        resetPhotoFrame(containerId, inputId, previewId);
    }
}

// Enhance showTab to reset when switching away from Borrow/Return
const originalShowTab = showTab;
showTab = function(tabName) {
    const activeTab = document.querySelector('.tab-content.active');
    if (activeTab && activeTab.id === 'borrowTab' && tabName !== 'borrowTab') {
        resetFormExceptDates('borrowForm', 'borrowPhotoContainer', 'borrowPhoto', 'borrowPreview');
    }
    if (activeTab && activeTab.id === 'returnTab' && tabName !== 'returnTab') {
        resetFormExceptDates('returnForm', 'returnPhotoContainer', 'returnPhoto', 'returnPreview');
    }
    originalShowTab(tabName);
}


// Restrict Perkiraan pengembalian Date to today or later
document.addEventListener('DOMContentLoaded', () => {
    const expectedReturnInput = document.getElementById('expectedReturn');
    if (expectedReturnInput) {
        const setMinToday = () => {
            const today = new Date().toISOString().split('T')[0];
            expectedReturnInput.min = today;
            if (expectedReturnInput.value && expectedReturnInput.value < today) {
                expectedReturnInput.value = today;
            }
        };
        setMinToday();
        expectedReturnInput.addEventListener('input', setMinToday);
    }
});



document.addEventListener('DOMContentLoaded', () => {
    const expectedReturnInput = document.getElementById('expectedReturn');
    if (expectedReturnInput) {
        const today = new Date().toISOString().split('T')[0];
        expectedReturnInput.min = today;
    }
});

</script>
</body>
</html>
